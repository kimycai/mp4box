name: Build FFmpeg (Ubuntu24.04) & Push to kimycai/MP4BOX
on:
  workflow_dispatch: # 仅手动触发

env:
  DOCKER_BUILDKIT: 1
  TARGET_REPO: kimycai/MP4BOX
  TARGET_BRANCH: main

jobs:
  build-ffmpeg-push:
    name: Build FFmpeg Ubuntu24.04 & Push to MP4BOX
    runs-on: ubuntu-24.04
    steps:
      # 步骤1：配置Git全局身份（推送仓库必备）
      - name: Configure Git Global Identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # 步骤2：拉取你的 kimycai/MP4BOX 仓库（含.git，用于推送）
      - name: Checkout kimycai/MP4BOX Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_REPO }}
          ref: ${{ env.TARGET_BRANCH }}
          token: ${{ secrets.WRAPPER_PUSH_TOKEN }}
          path: MP4BOX
          fetch-depth: 1

      # 步骤3：清理磁盘空间（解决Actions运行器磁盘不足）
      - name: Free Up Disk Space
        run: |
          df -h
          sudo apt-get clean
          docker system prune -a -f || true
          sudo rm -rf /opt/ghc /usr/local/.ghcup /usr/local/lib/android /var/lib/apt/lists/*
          df -h

      # 步骤4：拉取FFmpeg-Builds官方编译脚本
      - name: Checkout FFmpeg-Builds Source
        uses: actions/checkout@v4
        with:
          repository: BtbN/FFmpeg-Builds
          fetch-depth: 1
          path: ffmpeg-builds

      # 步骤5：配置Docker Buildx（加速镜像构建）
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          buildkitd-config: ${{ github.workspace }}/ffmpeg-builds/.github/buildkit.toml

      # 步骤6：登录GHCR（拉取官方FFmpeg构建镜像权限）
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      # 步骤7：核心修复：生成编译配置+编译FFmpeg（使用官方镜像，避免自定义镜像缺失）
      - name: Build FFmpeg for Ubuntu24.04 (linux64 static)
        run: |
          cd ${{ github.workspace }}/ffmpeg-builds
          # 生成linux64-gpl最小化编译配置（仅支持m4a→flac）
          ./generate.sh linux64 gpl
          # 关键：替换为FFmpeg官方构建镜像，避免自定义镜像不存在
          export DOCKER_IMAGE=ghcr.io/btbn/ffmpeg-builds/base-linux64:latest
          # 执行编译，生成静态可执行文件（所有依赖静态链接）
          T="$(echo -n ${{ github.token }} | sha256sum | head -c 64)"
          echo -e "::add-mask::${T}\n::stop-commands::${T}"
          ./build.sh linux64 gpl

      # 步骤8：提取ffmpeg静态可执行文件到MP4BOX仓库根目录
      - name: Extract FFmpeg Binary to MP4BOX Repo
        run: |
          # 查找编译后的静态FFmpeg压缩包
          FFMPEG_TAR=$(find ${{ github.workspace }}/ffmpeg-builds/artifacts -name "*-linux64-*.tar.xz" | head -1)
          mkdir -p ${{ github.workspace }}/ffmpeg-tmp
          tar -xJf $FFMPEG_TAR -C ${{ github.workspace }}/ffmpeg-tmp
          # 复制静态ffmpeg可执行文件到MP4BOX仓库根目录
          cp ${{ github.workspace }}/ffmpeg-tmp/bin/ffmpeg ${{ github.workspace }}/MP4BOX/
          chmod +x ${{ github.workspace }}/MP4BOX/ffmpeg
          # 验证：确认是静态可执行文件
          file ${{ github.workspace }}/MP4BOX/ffmpeg | grep -q "statically linked" && echo "✅ FFmpeg is static build"

      # 步骤9：提交并推送到 kimycai/MP4BOX 仓库
      - name: Commit & Push FFmpeg to MP4BOX
        run: |
          cd ${{ github.workspace }}/MP4BOX
          git add ./ffmpeg
          git commit -m "Update FFmpeg (Ubuntu24.04 | linux64 static | m4a→flac) - $(date +%Y%m%d_%H%M%S)" || echo "No changes to commit"
          git push origin ${{ env.TARGET_BRANCH }}

name: Native Build FFmpeg 5.0 (Ubuntu24.04) & Push to MP4BOX
on:
  workflow_dispatch: # 仅手动触发

env:
  TARGET_REPO: kimycai/MP4BOX
  TARGET_BRANCH: main
  FFMPEG_VERSION: 5.0
  # 微调配置：新增2个FFmpeg5.0静态编译兼容参数，其余核心参数保留
  FFMPEG_CONFIG: --prefix=/usr/local --disable-all --enable-static --disable-shared \
    --enable-avcodec --enable-avformat --enable-avutil --enable-swresample \
    --enable-decoder=aac,alac --enable-encoder=flac \
    --enable-muxer=flac --enable-demuxer=aac,mp4,m4a \
    --enable-protocol=file --disable-doc --disable-ffplay --disable-ffprobe \
    --disable-network --disable-zlib --disable-iconv \
    --extra-ldflags="-lpthread -lm" \ # 新增：链接静态线程库+数学库，解决基础依赖
    --disable-pie # 新增：FFmpeg5.0静态编译兼容，避免链接冲突

jobs:
  build-ffmpeg5.0-native:
    name: Compile FFmpeg 5.0 Static & Push
    runs-on: ubuntu-24.04
    steps:
      - name: Configure Git Global Identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Checkout kimycai/MP4BOX Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_REPO }}
          ref: ${{ env.TARGET_BRANCH }}
          token: ${{ secrets.WRAPPER_PUSH_TOKEN }}
          path: MP4BOX
          fetch-depth: 1

      - name: Free Disk & Install **STATIC** Build Dependencies
        run: |
          df -h
          sudo apt-get clean && sudo rm -rf /var/lib/apt/lists/* /opt/ghc /usr/local/.ghcup
          sudo apt-get update -y
          # 核心修改：安装「静态版依赖库」（结尾带-dev的是开发库，含静态.a文件）
          sudo apt-get install -y --no-install-recommends \
            gcc g++ make pkg-config wget tar xz-utils \
            libflac-dev libogg-dev \ # flac/ogg 静态编解码依赖
            libc6-dev libpthread-stubs0-dev libm-dev \ # C标准库/线程库/数学库 静态依赖
            zlib1g-dev # 基础压缩库静态依赖（备用，避免隐性缺失）
          df -h

      - name: Download FFmpeg 5.0 Official Source Code
        run: |
          mkdir -p ffmpeg-build && cd ffmpeg-build
          wget -c https://ffmpeg.org/releases/ffmpeg-${{ env.FFMPEG_VERSION }}.tar.xz -O - | tar -xJf -
          cd ffmpeg-${{ env.FFMPEG_VERSION }}
          ls -lah configure && echo "✅ FFmpeg 5.0 源码下载成功"

      - name: Configure & Compile FFmpeg 5.0 (Static Build)
        run: |
          cd ffmpeg-build/ffmpeg-${{ env.FFMPEG_VERSION }}
          ./configure ${{ env.FFMPEG_CONFIG }}
          make -j$(nproc) # 多线程编译，加速完成
          ls -lah ffmpeg && echo "✅ FFmpeg 5.0 纯静态版编译成功"

      - name: Copy FFmpeg 5.0 to MP4BOX & Add Exec Permission
        run: |
          cp ffmpeg-build/ffmpeg-${{ env.FFMPEG_VERSION }}/ffmpeg ./MP4BOX/
          chmod +x ./MP4BOX/ffmpeg
          # 验证静态版+可运行
          file ./MP4BOX/ffmpeg | grep -q "statically linked" && echo "✅ 纯静态版验证通过"
          ./MP4BOX/ffmpeg -version && echo "✅ FFmpeg 5.0 运行验证通过"

      - name: Commit & Push FFmpeg 5.0 to Repository
        run: |
          cd ./MP4BOX
          git add ./ffmpeg
          git commit -m "Native Build FFmpeg 5.0 (Ubuntu24.04 | static | m4a→flac) - $(date +%Y%m%d_%H%M%S)" || echo "ℹ️ No changes to commit"
          git push origin ${{ env.TARGET_BRANCH }}

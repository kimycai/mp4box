name: Build MP4Box & Push to kimycai/MP4BOX
# 纯手动触发，无自动执行规则
on:
  workflow_dispatch:

jobs:
  build-and-push-mp4box:
    runs-on: ubuntu-24.04
    steps:
      # 步骤1：配置Git全局身份（推送仓库必备）
      - name: Configure Git Global Identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # 步骤2：拉取你的 kimycai/MP4BOX 仓库（核心：path指定相对路径，Git目录自动生成）
      - name: Checkout kimycai/MP4BOX Repository
        uses: actions/checkout@v4
        with:
          repository: kimycai/MP4BOX
          ref: main
          token: ${{ secrets.WRAPPER_PUSH_TOKEN }}
          path: MP4BOX  # 相对路径，实际Git目录为 ./MP4BOX（含.git文件夹）
          fetch-depth: 1

      # 步骤3：安装GPAC编译依赖 + 清理缓存
      - name: Install Build Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y --no-install-recommends gcc make zlib1g-dev ca-certificates
          sudo apt clean
          sudo rm -rf /var/lib/apt/lists/*

      # 步骤4：拉取GPAC官方源码（github.com/gpac/gpac.git，浅克隆提速）
      - name: Clone GPAC Official Source Code
        run: |
          mkdir -p gpac-build  # 相对路径创建编译目录，避免路径混乱
          cd gpac-build
          git clone --depth 1 https://github.com/gpac/gpac.git
          cd gpac

      # 步骤5：静态编译MP4Box（官方配置：禁用zlib + 4线程）
      - name: Build Static MP4Box
        run: |
          cd gpac-build/gpac
          ./configure --static-mp4box --use-zlib=no
          make -j4

      # 步骤6：复制编译产物到MP4BOX仓库根目录 + 赋权（修正路径：指向相对路径的Git仓库）
      - name: Copy MP4Box to MP4BOX Git Repo
        run: |
          # 从编译目录复制产物到 ./MP4BOX（正确的Git仓库根目录）
          cp gpac-build/gpac/bin/gcc/MP4Box ./MP4BOX/
          # 赋予可执行权限，双重保障
          chmod +x ./MP4BOX/MP4Box
          # 验证产物：确认文件存在且带可执行权限
          ls -lahp ./MP4BOX/MP4Box

      # 步骤7：提交并推送（核心修正：进入相对路径的Git仓库，所有git命令正常执行）
      - name: Commit & Push MP4Box to kimycai/MP4BOX
        run: |
          # 进入正确的Git仓库目录（含.git文件夹，无目录错误）
          cd ./MP4BOX
          # 仅暂存MP4Box文件，精准提交无冗余
          git add ./MP4Box
          # 提交信息带时间戳，便于版本追溯
          git commit -m "Update MP4Box (static build | GPAC official | Ubuntu24.04) - $(date +%Y%m%d_%H%M%S)" || echo "No changes to commit (MP4Box is already the latest)"
          # 推送到远程main分支（Action自动关联origin，无需手动配置）
          git push origin main

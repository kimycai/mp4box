name: Build MP4Box & Push to kimycai/MP4BOX
# 纯手动触发，无自动执行规则
on:
  workflow_dispatch:

jobs:
  build-mp4box-linux:
    runs-on: ubuntu-24.04
    outputs:
      commit_msg: ${{ steps.generate-commit-msg.outputs.msg }}
    steps:
      # 步骤1：生成提交信息
      - name: Generate Commit Message
        id: generate-commit-msg
        run: |
          msg="Update MP4Box (static build | GPAC official | Linux) - $(date +%Y%m%d_%H%M%S)"
          echo "msg=$msg" >> $GITHUB_OUTPUT
          
      # 步骤2：配置Git全局身份（推送仓库必备）
      - name: Configure Git Global Identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # 步骤3：拉取你的 kimycai/MP4BOX 仓库（核心：path指定相对路径，Git目录自动生成）
      - name: Checkout kimycai/MP4BOX Repository
        uses: actions/checkout@v4
        with:
          repository: kimycai/MP4BOX
          ref: main
          token: ${{ secrets.WRAPPER_PUSH_TOKEN }}
          path: MP4BOX  # 相对路径，实际Git目录为 ./MP4BOX（含.git文件夹）
          fetch-depth: 1

      # 步骤4：安装GPAC编译依赖 + 清理缓存
      - name: Install Build Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y --no-install-recommends gcc make zlib1g-dev ca-certificates
          sudo apt clean
          sudo rm -rf /var/lib/apt/lists/*

      # 步骤5：拉取GPAC官方源码（github.com/gpac/gpac.git，浅克隆提速）
      - name: Clone GPAC Official Source Code
        run: |
          mkdir -p gpac-build  # 相对路径创建编译目录，避免路径混乱
          cd gpac-build
          git clone --depth 1 https://github.com/gpac/gpac.git
          cd gpac

      # 步骤6：静态编译MP4Box（官方配置：禁用zlib + 4线程）
      - name: Build Static MP4Box
        run: |
          cd gpac-build/gpac
          ./configure --static-mp4box --use-zlib=no
          make -j4

      # 步骤7：复制编译产物到MP4BOX仓库根目录 + 赋权（修正路径：指向相对路径的Git仓库）
      - name: Copy MP4Box to MP4BOX Git Repo
        run: |
          # 从编译目录复制产物到 ./MP4BOX（正确的Git仓库根目录）
          cp gpac-build/gpac/bin/gcc/MP4Box ./MP4BOX/MP4Box
          # 赋予可执行权限，双重保障
          chmod +x ./MP4BOX/MP4Box
          # 验证产物：确认文件存在且带可执行权限
          ls -lahp ./MP4BOX/MP4Box

  build-mp4box-windows:
    runs-on: windows-latest  # 使用Windows环境编译Windows版本
    outputs:
      commit_msg: ${{ steps.generate-commit-msg.outputs.msg }}
    steps:
      # 步骤1：生成提交信息
      - name: Generate Commit Message
        id: generate-commit-msg
        run: |
          $dateStr = Get-Date -Format 'yyyyMMdd_HHmmss'
          $msg = "Update MP4Box.exe (static build | GPAC official | Windows) - $($dateStr)"
          echo "msg=$msg" >> $env:GITHUB_OUTPUT

      # 步骤2：拉取GPAC官方源码（github.com/gpac/gpac.git，浅克隆提速）
      - name: Clone GPAC Official Source Code
        run: |
          git clone --depth 1 https://github.com/gpac/gpac.git
          cd gpac

      # 步骤3：使用Visual Studio编译MP4Box（最小化解决方案，零依赖）
      - name: Build Static MP4Box with Visual Studio
        run: |
          # 检查并进入Visual Studio编译目录
          $buildDirs = @("gpac\build\msvc10", "gpac\build\msvc14", "gpac\build\msvc")
          
          $selectedDir = $null
          foreach ($dir in $buildDirs) {
              if (Test-Path $dir) {
                  $selectedDir = $dir
                  Write-Host "Found build directory: $dir"
                  break
              }
          }
          
          if (-not $selectedDir) {
              # 如果没找到预设的目录，列出gpac\build下的所有目录
              Write-Host "Looking for build directories in gpac\build..."
              Get-ChildItem -Path "gpac\build" -Directory | ForEach-Object {
                  Write-Host "Found directory: $($_.Name)"
              }
              throw "No supported build directory found in gpac\build"
          }
          
          Set-Location $selectedDir
          
          # 检查是否存在最小化解决方案文件
          $solutionFile = $null
          if (Test-Path "gpac_mp4box_mini.sln") {
              $solutionFile = "gpac_mp4box_mini.sln"
              Write-Host "Found minimal solution: $solutionFile"
          } elseif (Test-Path "gpac.sln") {
              $solutionFile = "gpac.sln"
              Write-Host "Found main solution: $solutionFile"
          } else {
              # 查找任何 .sln 文件
              $slnFiles = Get-ChildItem -Path . -Filter "*.sln" -Name
              if ($slnFiles.Count -gt 0) {
                  $solutionFile = $slnFiles[0]
                  Write-Host "Found solution file: $solutionFile"
              } else {
                  throw "No solution file found in $selectedDir"
              }
          }
          
          # 查找并使用Visual Studio Developer Command Prompt
          $vsInstallerPath = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          if (Test-Path $vsInstallerPath) {
              $vsPath = & $vsInstallerPath -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath
              if ($vsPath) {
                  $msbuildPath = Join-Path $vsPath "MSBuild\Current\Bin\MSBuild.exe"
                  if (Test-Path $msbuildPath) {
                      $msbuild = $msbuildPath
                  }
              }
          }
          
          # 如果上面没找到，尝试常见的安装路径
          if (-not $msbuild) {
              $possiblePaths = @(
                  "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\MSBuild.exe",
                  "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2022\Professional\MSBuild\Current\Bin\MSBuild.exe",
                  "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin\MSBuild.exe",
                  "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2019\Enterprise\MSBuild\Current\Bin\MSBuild.exe",
                  "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2019\Professional\MSBuild\Current\Bin\MSBuild.exe",
                  "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2019\Community\MSBuild\Current\Bin\MSBuild.exe",
                  "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2017\Enterprise\MSBuild\15.0\Bin\MSBuild.exe",
                  "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2017\Professional\MSBuild\15.0\Bin\MSBuild.exe",
                  "${env:ProgramFiles(x86)}\Microsoft Visual Studio\2017\Community\MSBuild\15.0\Bin\MSBuild.exe"
              )
              
              foreach ($path in $possiblePaths) {
                  if (Test-Path $path) {
                      $msbuild = $path
                      break
                  }
              }
          }
          
          if (-not $msbuild) {
              throw "MSBuild.exe not found. Please ensure Visual Studio is installed."
          }
          
          Write-Host "Using MSBuild at: $msbuild"
          
          # 根据解决方案类型选择合适的配置
          if ($solutionFile -eq "gpac_mp4box_mini.sln") {
              # 编译Release版本的MP4Box（使用最小化解决方案）
              & $msbuild $solutionFile /p:Configuration=Release /p:Platform=Win32 /m
          } else {
              # 如果不是最小化解决方案，尝试编译MP4Box_only配置
              & $msbuild $solutionFile /p:Configuration="Release - MP4Box_only" /p:Platform=x64 /p:PlatformToolset=v143 /m
          }

      # 步骤4：复制编译产物到MP4BOX仓库根目录
      - name: Copy MP4Box.exe to MP4BOX Git Repo
        run: |
          # 检查编译产物是否存在（使用最小化解决方案的输出路径）
          $sourcePath = "gpac\bin\Release\mp4box.exe"
          if (-Not (Test-Path $sourcePath)) {
              # 如果上述路径不存在，尝试其他可能的路径
              Write-Host "Checking alternative output paths..."
              Get-ChildItem -Path "gpac\bin" -Recurse -Name "mp4box.exe" | ForEach-Object {
                  $foundPath = "gpac\bin\$_"
                  Write-Host "Found mp4box.exe at: $foundPath"
                  Copy-Item $foundPath -Destination "./MP4BOX/MP4Box.exe" -Force
              }
          } else {
              # 从编译目录复制产物到 ./MP4BOX（正确的Git仓库根目录）
              Write-Host "Found mp4box.exe at: $sourcePath"
              Copy-Item $sourcePath -Destination "./MP4BOX/MP4Box.exe" -Force
          }

          # 验证产物：确认文件存在
          if (Test-Path "./MP4BOX/MP4Box.exe") {
              Get-ChildItem "./MP4BOX/MP4Box.exe"
          } else {
              throw "MP4Box.exe was not found in the expected location. Check build logs for errors."
          }

  push-all-binaries:
    needs: [build-mp4box-linux, build-mp4box-windows]
    runs-on: ubuntu-24.04
    steps:
      # 步骤1：配置Git全局身份（推送仓库必备）
      - name: Configure Git Global Identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # 步骤2：拉取kimycai/MP4BOX仓库
      - name: Checkout kimycai/MP4BOX Repository
        uses: actions/checkout@v4
        with:
          repository: kimycai/MP4BOX
          ref: main
          token: ${{ secrets.WRAPPER_PUSH_TOKEN }}
          path: MP4BOX
          fetch-depth: 1

      # 步骤3：提交所有二进制文件并推送
      - name: Commit & Push All Binaries to kimycai/MP4BOX
        run: |
          cd ./MP4BOX
          # 添加所有平台的二进制文件
          git add ./MP4Box
          git add ./MP4Box.exe
          # 提交信息包含所有平台
          git commit -m "Update MP4Box binaries (Linux & Windows static builds | GPAC official) - $(date +%Y%m%d_%H%M%S)" || echo "No changes to commit (binaries are already the latest)"
          git push origin main

name: Build MP4Box & Push to kimycai/mp4box
# 纯手动触发，无自动执行规则
on:
  workflow_dispatch:

jobs:
  build-and-push-mp4box:
    runs-on: ubuntu-24.04
    steps:
      # 步骤1：配置Git全局身份（推送仓库必备）
      - name: Configure Git Global Identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # 步骤2：拉取修改后的 kimycai/mp4box 仓库（核心：仓库名改为小写mp4box）
      - name: Checkout kimycai/mp4box Repository
        uses: actions/checkout@v4
        with:
          repository: kimycai/mp4box  # 适配：仓库名改为小写mp4box
          ref: main
          token: ${{ secrets.WRAPPER_PUSH_TOKEN }}
          path: mp4box-repo  # 目录名同步改为小写，避免混淆
          fetch-depth: 1

      # 步骤3：安装GPAC编译依赖 + 清理缓存
      - name: Install Build Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y --no-install-recommends gcc make zlib1g-dev ca-certificates
          sudo apt clean
          sudo rm -rf /var/lib/apt/lists/*

      # 步骤4：拉取GPAC官方源码（浅克隆提速，不影响编译）
      - name: Clone GPAC Official Source Code
        run: |
          mkdir -p gpac-build
          cd gpac-build
          git clone --depth 1 https://github.com/gpac/gpac.git
          cd gpac

      # 步骤5：静态编译MP4Box（官方配置，无动态依赖，跨系统兼容）
      - name: Build Static MP4Box
        run: |
          cd gpac-build/gpac
          ./configure --static-mp4box --use-zlib=no
          make -j4

      # 步骤6：复制产物并**重命名为小写mp4box** + 赋权（核心需求）
      - name: Copy & Rename MP4Box to mp4box
        run: |
          # 复制编译产物并直接重命名为小写mp4box，推送到仓库根目录
          cp gpac-build/gpac/bin/gcc/MP4Box ./mp4box-repo/mp4box
          # 双重赋予可执行权限，保障推送后可直接运行
          chmod +x ./mp4box-repo/mp4box
          # 验证产物：确认小写mp4box存在且带可执行权限
          ls -lahp ./mp4box-repo/mp4box

      # 步骤7：提交小写mp4box并推送至 kimycai/mp4box 仓库
      - name: Commit & Push mp4box to kimycai/mp4box
        run: |
          cd ./mp4box-repo  # 进入正确的Git仓库目录（含.git）
          # 仅暂存小写mp4box文件，不影响仓库现有ffmpeg等文件
          git add ./mp4box
          # 提交信息标注仓库名+小写，便于版本追溯
          git commit -m "Update mp4box (static build | lowercase | GPAC official | Ubuntu24.04) - $(date +%Y%m%d_%H%M%S)" || echo "No changes to commit (mp4box is already the latest)"
          # 推送到远程main分支（Action自动关联origin，无需手动配置）
          git push origin main
